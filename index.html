<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Web Wallet</title>
    <script src="https://cdn.jsdelivr.net/npm/tonweb@latest"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #00f;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        h1 {
            color: #00f;
        }

        input, button {
            padding: 10px;
            margin: 10px;
            width: 300px;
            border-radius: 5px;
            border: 1px solid #00f;
            background-color: #111;
            color: #00f;
            transition: background-color 0.3s, transform 0.3s;
        }

        input:focus, button:hover {
            background-color: #222;
            transform: scale(1.05);
        }

        button {
            cursor: pointer;
        }

        #stars {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: black;
            overflow: hidden;
            z-index: -1;
        }

        #stars::after {
            content: '';
            width: 100%;
            height: 100%;
            background: url('https://raw.githubusercontent.com/kushagraSahu/css-star-animation/master/img/stars.png') repeat;
            animation: stars 50s linear infinite;
            position: absolute;
        }

        @keyframes stars {
            from { background-position: 0 0; }
            to { background-position: -10000px 5000px; }
        }
    </style>
</head>
<body>
    <div id="stars"></div>

    <h1>TON Web Wallet</h1>

    <!-- عرض عنوان المحفظة -->
    <div>
        <label>Your Wallet Address:</label>
        <p id="wallet-address">Not Connected</p>
    </div>

    <!-- ربط المحفظة باستخدام Tonkeeper -->
    <button onclick="connectTonkeeper()">Connect via Tonkeeper</button>

    <!-- إرسال العملات -->
    <div>
        <input type="text" id="recipientAddress" placeholder="Recipient Address">
        <input type="text" id="amount" placeholder="Amount (TON)">
        <button onclick="sendTransaction()">Send Transaction</button>
    </div>

    <!-- استلام العملات -->
    <div>
        <input type="text" id="transactionMessage" placeholder="Transaction Message">
        <button onclick="receiveTransaction()">Receive Transaction</button>
    </div>

    <!-- رسائل التفاعل -->
    <div>
        <p id="status">Status: Waiting for action...</p>
    </div>

    <!-- Firebase Integration -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCAjKT4voELBTg_XXMjZjvF54jRYi8_N-0",
        authDomain: "alextest-79a46.firebaseapp.com",
        projectId: "alextest-79a46",
        storageBucket: "alextest-79a46.firebasestorage.app",
        messagingSenderId: "671025130789",
        appId: "1:671025130789:web:2f213ee6a95514906d7ecc",
        measurementId: "G-CT2398KFG8"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Function to save transaction in Firebase
      function saveTransaction(transaction) {
          db.collection("transactions").add(transaction)
          .then((docRef) => {
              console.log("Transaction saved with ID: ", docRef.id);
          })
          .catch((error) => {
              console.error("Error adding transaction: ", error);
          });
      }

      // TON wallet and transaction logic
      let tonweb, wallet, keyPair;

      function connectTonkeeper() {
          document.getElementById('status').textContent = "Tonkeeper connection initiated...";
          window.open('tonkeeper://connect', '_blank');
      }

      async function sendTransaction() {
          const recipientAddress = document.getElementById('recipientAddress').value;
          const amount = document.getElementById('amount').value;

          if (!recipientAddress || !amount || !wallet || !keyPair) {
              alert('Please make sure to enter all required fields and connect wallet.');
              return;
          }

          try {
              const amountNano = TonWeb.utils.toNano(amount); // تحويل إلى نانو TON
              const seqno = await wallet.methods.seqno().call();

              const transfer = wallet.methods.transfer({
                  secretKey: keyPair.secretKey,
                  toAddress: recipientAddress,
                  amount: amountNano,
                  seqno: seqno,
                  payload: 'Transaction from TON Web Wallet',
                  sendMode: 3,
              });

              await transfer.send();
              document.getElementById('status').textContent = "Transaction sent successfully!";

              // Save transaction in Firebase
              const transaction = {
                  recipientAddress: recipientAddress,
                  amount: amount,
                  timestamp: new Date().toISOString()
              };
              saveTransaction(transaction);

          } catch (error) {
              document.getElementById('status').textContent = "Transaction failed. Error: " + error.message;
          }
      }

      function receiveTransaction() {
          const transactionMessage = document.getElementById('transactionMessage').value;
          if (transactionMessage) {
              document.getElementById('status').textContent = "Transaction received: " + transactionMessage;
          } else {
              document.getElementById('status').textContent = "No transaction message provided.";
          }
      }
    </script>
</body>
</html>
